<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pantanal.read.common.dao.BookDao">

    <resultMap id="book_resultmap" type="com.pantanal.read.common.bean.BookBean">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="book_id" property="bookId"/>
        <result column="cover_url" property="coverUrl"/>
        <result column="intro" property="intro"/>
        <result column="author" property="author"/>
        <result column="is_finished" property="isFinished"/>
        <result column="free" property="free"/>
        <result column="type_id" property="typeId"/>
        <result column="type_name" property="typeName"/>
        <result column="word_num" property="wordNum"/>

        <result column="click_num" property="clickNum"/>
        <result column="url" property="url"/>
        <result column="collection_num" property="collectionNum"/>
        <result column="recommend_num" property="recommendNum"/>
        <result column="create_time" property="createTime"/>
        <result column="chapter_count" property="chapterCount"/>
        <result column="last_chapter_id" property="lastChapterId"/>
        <result column="channel_ids" property="channelIds" typeHandler="com.pantanal.read.common.bean.type.JsonTypeHandler"/>

        <association property="lastChapter" javaType="com.pantanal.read.common.bean.BookChapterBean">
            <id column="last_chapter.id" property="id"/>
            <result column="last_chapter.name" property="name"/>
            <result column="last_chapter.index" property="index"/>
            <result column="last_chapter.desc" property="desc"/>
            <result column="last_chapter.create_time" property="createTime"/>
            <result column="id" property="bookId"/>
        </association>
        <association property="freeChapter" javaType="com.pantanal.read.common.bean.BookChapterBean">
            <id column="free_chapter.id" property="id"/>
            <result column="free_chapter.name" property="name"/>
            <result column="free_chapter.index" property="index"/>
            <result column="free_chapter.desc" property="desc"/>
            <result column="free_chapter.create_time" property="createTime"/>
            <result column="id" property="bookId"/>
        </association>
    </resultMap>


    <sql id="queryFrom">
        from book as book
        LEFT JOIN book_chapter AS last_chapter ON book.last_chapter_id = last_chapter.id
        LEFT JOIN book_chapter AS free_chapter ON book.free_chapter_id = free_chapter.id
        where 1=1
        <if test="id !=null ">
            and book.id = #{id}
        </if>
        <if test="ids !=null ">
            and book.id in
            <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="name !=null ">
            and book.name like '%${name}%'
        </if>
        <if test="typeId !=null ">
            and book.type_id = #{typeId}
        </if>
    </sql>
    <select id="query" resultMap="book_resultmap" parameterType="com.pantanal.read.common.bean.BookBean">

        select book.*,

        last_chapter.id as `last_chapter.id`,
        last_chapter.name as `last_chapter.name`,
        last_chapter.index as `last_chapter.index`,
        last_chapter.desc as `last_chapter.desc`,
        last_chapter.create_time as `last_chapter.create_time`,

        free_chapter.id as `free_chapter.id`,
        free_chapter.name as `free_chapter.name`,
        free_chapter.index as `free_chapter.index`,
        free_chapter.desc as `free_chapter.desc`,
        free_chapter.create_time as `free_chapter.create_time`

        <include refid="queryFrom"></include>
        <if test="plimit > 0">
            limit #{pstart}, #{plimit}
        </if>

    </select>

    <select id="queryCount" resultType="java.lang.Integer" parameterType="com.pantanal.read.common.bean.BookBean">
        select count(1)
        <include refid="queryFrom"></include>
    </select>
</mapper>
